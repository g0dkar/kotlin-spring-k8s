FROM redis:4.0.11

MAINTAINER Johan Andersson <Grokzen@gmail.com>

# Some Environment Variables
ENV HOME /root
ENV DEBIAN_FRONTEND noninteractive

# Install system dependencies
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -yqq \
      net-tools supervisor ruby rubygems locales gettext-base wget && \
    apt-get clean -yqq

# # Ensure UTF-8 lang and locale
RUN locale-gen en_US.UTF-8
ENV LANG       en_US.UTF-8
ENV LC_ALL     en_US.UTF-8

# Necessary for gem installs due to SHA1 being weak and old cert being revoked
ENV SSL_CERT_FILE=/usr/local/etc/openssl/cert.pem

RUN gem install redis -v 4.0.1

RUN apt-get install -y gcc make g++ build-essential libc6-dev tcl git supervisor ruby

ARG redis_version=4.0.10

RUN wget -qO redis.tar.gz https://github.com/antirez/redis/archive/${redis_version}.tar.gz \
    && tar xfz redis.tar.gz -C / \
    && mv /redis-$redis_version /redis

ARG docker_version=18.06.1

RUN wget -qO docker.tar.gz https://download.docker.com/linux/static/stable/x86_64/docker-${docker_version}-ce.tgz \
    && tar --extract --file docker.tar.gz --strip-components 1 --directory /usr/local/bin/

RUN (cd /redis && make)

RUN mkdir /redis-conf
RUN mkdir /redis-data

COPY docker-data/redis.tmpl /redis-conf/redis.tmpl

COPY docker-data/redis-cluster.tmpl /redis-conf/redis-cluster.tmpl

# Add startup script
COPY docker-data/docker-entrypoint.sh /docker-entrypoint.sh

# Add script that generates supervisor conf file based on environment variables
COPY docker-data/generate-supervisor-conf.sh /generate-supervisor-conf.sh

RUN chmod 755 /docker-entrypoint.sh

ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["redis-cluster"]
